# Бекэнд для ERP системы
 

# Зависимости
Для работы над проектом необходимо сначала установить зависимости:

```
pip install -r requirements.txt
pip install -r ptc_deco/requirements.txt
```

Для работоспособности команд непрерывной интеграции необходимо также установить дополнительные приложения.
В Windows, для этого нужно выполнить в PowerShell от имени администратора:
```
choco install zip
choco install openssh --pre 
choco install ssh-copy-id
```

Для установки Chocolatey нужно предварительно от имени администратора в PowerShell выполнить 
команду, приведенную по ссылке https://chocolatey.org/install.

При разработке в Windows, приложение работоспособно из окружения anaconda либо miniconda. Работоспособность под Windows вне miniconda и anaconda - не тестировалась.

# Команды непрерывной интеграции

Инструментарий непрерывной интеграции реализован с помощью библиотеки Fabric2.
Процесс развертывания приложения включает в себя 

  - Сборку whl-пакета и развертывание на удаленной машине виртуального окружения с установкой собранного whl-пакета.
  - Очистку артефактов сборки на локальной, очистку артефактов развертывания на удаленной машине.
  - Создание файла dotenv конфигурации на удаленной машине.
  - Создание и удаление конфигурации СУБД PostgreSQL. 
  - Применение миграций на удаленной машине.
  - Развертывание конфигурации nginx на удаленной машине.
  - Развертывание каталога static на удаленной машине.
  - Развертывание сервиса systemd на удаленной машине.

Для просмотра списка задач fabfile необходимо ввести `fab --list`

Для выполнения задачи необходимо ввести в терминале `fab имя_задачи`

## Конфигурация переменных окружения

Конфигурации переменных окружения задаются путем настройки файлов конфигурации:
```
.env                  # добавлен в репозиторий
.env.local            # локальная копия, в gitignore
.env.production       # добавлен в репозиторий
.env.production.local # локальная копия, в gitignore
```

Конфигурация является сквозной для проекта и для кода.

По умолчанию, `fab` использует `.env.local` и его необходимо создать по образцу содержимого в `.env`.
В коде используется только содержимое `.env.local`. 
Его необходимо создать локально, при деплое он создается автоматически на основе выбранного набора переменных окружения. 

Чтобы задать другой набо переменных окружения при вызове команд развертывания, необходимо задавать аргумент 
`--dotenv=имя_файла_набора`.

Например: `fab deploy --dotenv=.env.production.local`

Для отладки fabric-скриптов можно использовать файл `ci/fabdebug.py` в качестве точки входа.

### Описание параметров файла окружения

| Параметр              | Пример значения            | Описание                                                                                                                 | 
| ----------------------|----------------------------|------------------------------------------------------------------------------------------------------------------------- |
| DEPLOY_SERVER         | username@domain            | Адрес удаленной машины, на которой будет выполняться развертывание.                                                      | 
| DEPLOY_DIR            | /opt/ptcdeco               | Каталог на удаленной машине, в который будет развернуто приложение.                                                      | 
| KEY_FILENAME          | C:\Users\Win10\.ssh\id_rsa | Закрытный (приватный) ssh-ключ для беспарольной аутентификации на удаленной машине.                                      | 
| BACKEND_USER          | ptcbackend                 | Имя пользователя на удаленной машине, от которого будет запускаться бекэнд. Пользователь создается автоматически.        | 
| SUDO_PASSWORD         | 123                        | Пароль рута на удаленной машине.                                                                                         | 
| REMOTE_PYTHON_CMD     | python3.6                  | Команда интерпретатора Python на удаленной машине. Python должен быть не ниже 3.6.                                       | 
| USE_SQLITE            | 0 или 1                    | 1 - использовать sqlite локально при разработке и при развертывании. 0 - использовать PostgreSQL.                        | 
| SHOW_GRAPHIQL         | 0 или 1                    | 1 - отобразить интерфейс GraphiQL на удаленной машине, 0 - не отображать GraphiQL.                                       | 
| PG_DBNAME             | ptcdeco                    | Имя базы данных                                                                                                          | 
| PG_USER               | ptcbackend                 | Пользователь СУБД                                                                                                        | 
| PG_PASSWORD           | ptcbackend                 | Пароль пользователя СУБД                                                                                                 | 
| PG_HOST               | localhost                  | Адрес хоста СУБД: в локальной сети при разработке, относительно удаленной машины при развертывании.                      | 
| PG_PORT               | 5432                       | Порт СУБД: локальный при разработке, относительно удаленной машины при развертывании.                                    | 
| PG_LOGGING            | 0 или 1                    | Включить или отключить вывод в лог запросов к PostgreSQL                                                                 | 
| PG_LOCAL_USER         | postgres                   | Локальный пользователь СУБД (используется для команд редеплоя, выполняемых на локальном узле PostgreSQL)                 |
| PG_LOCAL_PASSWORD     | postgres                   | Локальный пароль пользователя СУБД (используется для команд редеплоя, выполняемых на локальном узле PostgreSQL).         |
| SERVER_NAME           | allbot.online              | Доменное имя сервера для конфигурации nginx.                                                                             | 
| TUNNEL_REMOTE_HOST    | 172.22.0.36                | Удаленный сервер для туннелирования порта PostgreSQL.                                                                    | 
| TUNNEL_REMOTE_PORT_ON_REMOTE_MACHINE | 5432        | Порт PostgreSQL на удаленной машине туннелирования в локальный порт через SSH.                                           | 
| TUNNEL_REMOTE_PG_PORT | 5555                       | Локальный порт для туннелироваия подключения к удаленной СУБД с локальной машины.                                        | 
| DEPLOY_DBMS_LOCAL     | 0 или 1                    | 1 - моделировать команды развертывания СУБД локально, 0 - выполнять развертывание конфигурации СУБД на удаленной машине. | 
| DEBUG                 | 0 или 1                    | 1 - включить, 0 - отключить режим отладки.                                                                               |
| LOCALE                | ru_RU                      | Локаль, в которой работает приложение                                                                                    |
| DEPLOY_LOCALE         | ru_RU.utf-8                | Локаль, в которой работает приложение на удаленном сервере                                                               |
| GUNICORN_TIMEOUT      | 550                        | Таймаут ответов на запросы Gunicorn                                                                                      |
| GUNICORN_WORKERS      | 2                          | Количество рабочих процессов Gunicorn, выделенных на обработку запросов                                                  |
| REMOTE_DEBUG          | 0 или 1                    | Включить удаленную отладку или отключить                                                                                 |
| REMOTE_DEBUG_LOCAL_HOSTNAME | 172.22.0.36          | Удаленный хост, на котором должен работать удаленный отладчик                                                            |
| REMOTE_DEBUG_LOCAL_PORT | 172.22.0.36              | Порт удаленного хоста, на котором должен работать удаленный отладчик                                                     |


### Команды manage.py

| Команда                               | Назначение команды                                              |
| ------------------------------------- | --------------------------------------------------------------- |
| create_raw_ddl                        | Создать триггеры и хранимые процедуры                           |
| generate_xlsx                         | Генерировать xlsx отчеты согласно передаваемым аргументам       |
| load_additional_costs                 | Загрузить тестовые данные дополнительных расходов РТС           |
| load_constants                        | Загрузить константы в базу                                      |
| load_families                         | Загрузить иерархии семейств рекламных сторон                    |
| load_name_package                     | Загрузить файл "примеры пакетов"                                |
| load_partners                         | Загрузить базу контрагентов в БД                                |
| upload_projects_to_json               | Выгрузить продуктовые данные о проектах в JSON                  |
| load_projects_from_json               | Загрузить продуктовую базу проектов из ранее выгруженного JSON  |
| load_self_company_info                | Загрузить информацию об организации                             |
| load_um_constructions_nonrts          | Загрузить базу конструкций НОНРТС в БД                          |
| load_um_constructions_rts             | Загрузить базу конструкций РТС в БД                             |
| load_um_locations                     | Загрузить базу местоположений в БД                              |
| load_contracts                        | Загрузить тестовые договоры                                     |
| load_custom_users                     | Загрузить тестовых пользователей                                |
| load_designs                          | Загрузить тестовые дизайны                                      |
| load_estimates                        | Загрузить тестовые сметы (устарело, к удалению)                 |
| load_estimates_non_rts                | Загрузить тестовые доп. расходы НОН РТС                         |
| load_invoices                         | Загрузить тестовые данные счетов                                |
| load_mountings                        | Загрузить тестовые данные монтажей                              |
| load_package_in_construction_side     | Загрузить тестовые данные о пакете в стороны конструкций        |
| load_packages                         | Загрузить тестовые имена пакетов                                |
| load_placement_price                  | Загрузить тестовые данные о стоимости размещения                |
| load_projects                         | Загрузить тестовые данные о проектах                            |
| load_reservation_packages             | Загрузить тестовые пакетные бронирования (устарело, к удалению) |
| load_static_additional_costs          | Загрузить тестовые данные о постоянных доп. расходах            |
| load_test_working_sectors             | Загрузить тестовые данные о секторах деятельности               |
| load_test_mounting_kpi                | Загрузить тестовые данные монтажей                              |
| test_calculate                        | Выполнить тестовый расчет сметы                                 |

## Обновление выгрузки продуктовой базы 

1. Подключить VPN клиент
2. `.\ci\misc\tunnel_upload.bat`
3. `.\ci\misc\upload_and_load_projects.bat`

## Настройка непрерывной интеграции по коммиту в репозиторий
Автодеплой по комитам в репозиторий реализован с помощью конфигурационного файла `bitbucket-pipelines.yml`,
 который находится в корне проекта. По комиту стартует выполнение пайплайна, указанного в следующем виде:
 
```
pipelines:
    branches:
        ИМЯ_ВЕТКИ:
          - step:
              script:
                - СПИСОК ВЫПОЛНЯЕМЫХ КОМАНД
```

Для реализации цикла непрерывной интеграции по комиту необходимо создать соответствующую конфигурацию для заданной 
ветки.
При выполнении ssh-команд необходимо настроить аутентификацию по ssh-ключу и добавить данный ключ и содержимое 
known-hosts в base64 виде в список pipeline variables (с установленным чекбоксом "private") как описано в 
https://support.atlassian.com/bitbucket-cloud/docs/variables-and-secrets/

  1. Выполнить на любой машине, не закрывать терминал (потребуется вывод двух последних команд):
  
    ```
    ssh-keygen -t rsa -b 4096 -N '' -f my_ssh_key
    ssh-copy-id -t my_ssh_key АДРЕС_ЦЕЛЕВОЙ_МАШИНЫ
    base64 -w 0 < my_ssh_key
    base64 -w 0 < ~/.ssh/known_hosts
    ```
  
  2. Перейти в Bitbucket в Settings -> Pipelines -> Repository Variables

  3. Добавить base64 вывод терминала для `my_ssh_key` в одну переменную, а вывод для `known_hosts` - в другую переменную.
  4. Далее реализовать код `bitbucket-pipelines.yml` для настраиваемой ветки по аналогии с уже сделанными. Данный файл
можно редактировать прямо в web-интерфейсе Bitbucket.


# Генерация графического представления модели

1. Установить сборку `graphviz`, для этого сначала скачать
https://github.com/mahkoCosmo/GraphViz_x64/blob/master/graphviz-2.38_x64.tar.gz
2. Создать соответствующий каталог `Graphviz2.38` в `Program Files` для и распаковать архив.
3. `pip install --global-option=build_ext --global-option="-IC:\Program Files\Graphviz2.38\include" --global-option="-LC:\Program Files\Graphviz2.38\lib" pygraphviz`
4. Скопировать в каталог site-packages\pygraphviz файлы cdt.dll и cgraph.dll из `Graphviz2.38`.
   copy "C:\Program Files\Graphviz2.38\bin\*.dll" ".\venv\Lib\site-packages\pygraphviz"
5. ```
   .\venv\Scripts\deactivate.bat
   conda activate
   .\venv\Scripts\activate.bat
   set PATH=C:\Program Files (x86)\Graphviz2.38\bin;%PATH%
   python manage.py graph_models -a -g -o imagefile_name.png
   ```

# Быстрая установка PostgreSQL в Windows с заданным паролем
Каталог с предыдущей базой `C:\Program Files\PostgreSQL\12\data` не должен существовать. 
Если он есть, его нужно удалить. При этом будет уничтожено всё содержимое старой базы.

Для установки PostgreSQL в Windows с предзаданным паролем необходимо выполнить:

```
choco install postgresql12 --params '/Password:ПАРОЛЬ_ПОЛЬЗОВАТЕЛЯ_POSTGRES'
choco install pgadmin4
```

Запуск Ipython manage.py shell
```
python manage.py shell -i ipython
```


# Запуск логгирования PostgreSQL
В  `/etc/postgresql/12/main/postgresql.conf`

записать в конец строки:

```
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_statement = 'all'
logging_collector = on
```

Затем перезапустить сервис postgresql

```
systemctl restart postgresql
```

Затем команда

```
tail -f /var/lib/postgresql/12/main/pg_log/postgresql-2020-11-14_082407.log
```

будет выдавать простыню запросов



# Исправление ошибки записи в unix socket gunicorn демона main_sock на CentOS

Данная ошибка возникает из за ненастроенной политики SElinux.
Для исправления нужно выполнить:

```
sudo cat /var/log/audit/audit.log | grep nginx | grep denied | audit2allow -M ptcdeco && semodule -i ptcdeco.pp
```

# Возможные проблемы
Для работоспособности механизма хранения файлов, в системе должна быть доступна локаль ru_RU.UTF-8.


